<nz-layout class="h-full">
  <nz-header
    class="flex shrink-0 text-black bg-white shadow flex-row items-center"
    ><h2 class="m-0">Requests</h2>
    <span class="ml-auto flex flex-row items-center gap-2">
      @if(api.isAdmin()) {
      <button
        nz-button
        nzType="default"
        nz-tooltip
        nzTooltipPlacement="bottom"
        nzTooltipTitle="Attempt deployment to Promox for all requests in the database that are not yet completed."
      >
        Deploy requests
        <span nz-icon nzType="info-circle" nzTheme="outline"></span>
      </button>
      <button
        nz-button
        nzType="default"
        nz-tooltip
        nzTooltipPlacement="bottom"
        nzTooltipTitle="Resize all VMs in the range of 200 to 299 based on memory usage."
      >
        Resize VMs
        <span nz-icon nzType="info-circle" nzTheme="outline"></span>
      </button>
      }
      <button
        nz-button
        nzType="primary"
        (click)="newRequest.set(getNewUserRequestObject())"
      >
        Create
      </button>
    </span>
  </nz-header>
  <nz-content class="overflow-auto flex flex-col flex-grow p-3">
    <nz-table
      #table
      [nzFrontPagination]="false"
      [nzData]="requests()"
      class="h-full"
    >
      <thead>
        <tr>
          <th>Start Date</th>
          <th>End Date</th>
          <th>Processors</th>
          <th>Storage</th>
          <th>Memory</th>
          <th>OS</th>
          <th></th>
        </tr>
      </thead>
      <tbody>
        <tr *ngFor="let data of table.data">
          @if(!data.toBeRemoved) {
          <td>{{ data.startDate }}</td>
          <td>{{ data.endDate }}</td>
          <td>{{ data.vmDetails.processors }}</td>
          <td>{{ data.vmDetails.storageGb }}</td>
          <td>{{ data.vmDetails.memoryGb }}</td>
          <td>{{ data.vmDetails.template }}</td>
          <td>
            <div class="flex flex-row gap-2">
              <button nz-button nzDanger (click)="deleteRequestId.set(data.id)">
                <span nz-icon nzType="delete"></span>
              </button>
            </div>
          </td>
          }
        </tr>
      </tbody>
    </nz-table>
  </nz-content>
</nz-layout>

<nz-drawer
  [nzBodyStyle]="{ overflow: 'auto' }"
  [nzMaskClosable]="true"
  [nzVisible]="!!newRequest()"
  [nzTitle]="'Create Request'"
  [nzFooter]="footerTpl"
  (nzOnClose)="newRequest.set(null)"
  nzWidth="50%"
>
  <div *nzDrawerContent>
    <form
      nz-form
      [formGroup]="selectedRequestForm"
      (ngSubmit)="save()"
      class="bg-white shadow-md rounded-lg p-6"
    >
      <nz-form-item>
        <nz-form-label nzRequired>Start Date - End Date</nz-form-label>
        <nz-form-control>
          <nz-range-picker
            [nzShowTime]="true"
            formControlName="dateRange"
          ></nz-range-picker>
        </nz-form-control>
      </nz-form-item>
      <nz-form-item>
        <nz-form-label nzRequired>Processors</nz-form-label>
        <nz-form-control>
          <nz-input-number
            formControlName="processors"
            [nzMin]="0"
            [nzStep]="1"
          ></nz-input-number>
        </nz-form-control>
      </nz-form-item>
      <nz-form-item>
        <nz-form-label nzRequired>Storage</nz-form-label>
        <nz-form-control>
          <nz-input-number
            formControlName="storage"
            [nzMin]="0"
            [nzStep]="1"
          ></nz-input-number>
        </nz-form-control>
      </nz-form-item>
      <nz-form-item>
        <nz-form-label nzRequired>Memory</nz-form-label>
        <nz-form-control>
          <nz-input-number
            formControlName="memory"
            [nzMin]="0"
            [nzStep]="1"
          ></nz-input-number>
        </nz-form-control>
      </nz-form-item>
      <nz-form-item>
        <nz-form-label>OS</nz-form-label>
        <nz-form-control>
          <input nz-input formControlName="os" class="inline-block w-32" />
        </nz-form-control>
      </nz-form-item>
    </form>
  </div>
  <ng-template #footerTpl>
    <div class="flex flex-row gap-2">
      <button class="ml-auto" nz-button (click)="newRequest.set(null)">
        Cancel
      </button>
      <button nz-button nzType="primary" (click)="save()">Save</button>
    </div>
  </ng-template>
</nz-drawer>

<nz-modal
  [nzVisible]="!!deleteRequestId()"
  nzTitle="Confirm"
  (nzOnCancel)="deleteRequestId.set(null)"
  (nzOnOk)="deleteRequest(deleteRequestId()!)"
>
  <ng-container *nzModalContent>
    <p>Are you sure you want to delete request {{ deleteRequestId() }}?</p>
  </ng-container>
</nz-modal>
